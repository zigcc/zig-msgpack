name: Unit Tests

run-name: "ğŸ§ª Unit Tests Â· ${{ github.event_name == 'schedule' && 'Scheduled (master)' || (github.event_name == 'workflow_dispatch' && 'Manual Run' || github.event.workflow_run.head_branch) }}"

on:
    schedule:
        # æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œ
        - cron: "0 2 * * *"
    workflow_dispatch:
    workflow_run:
        workflows: ["Code Format Check"]
        types:
            - completed

jobs:
    test:
        name: Unit Test (${{ matrix.os }} - ${{ matrix.arch }})
        # ä¾èµ– format check æˆåŠŸï¼Œæˆ–å®šæ—¶ä»»åŠ¡/æ‰‹åŠ¨è§¦å‘æ—¶æ‰§è¡Œ
        if: |
            github.event_name == 'schedule' ||
            github.event_name == 'workflow_dispatch' ||
            (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
        strategy:
            matrix:
                include:
                    # Linux x86_64
                    - os: ubuntu-latest
                      arch: x86_64
                      runner: ubuntu-latest
                    # Linux aarch64
                    - os: ubuntu-latest
                      arch: aarch64
                      runner: ubuntu-24.04-arm
                    # macOS x86_64
                    - os: macos-latest
                      arch: x86_64
                      runner: macos-13
                    # macOS arm64
                    - os: macos-latest
                      arch: arm64
                      runner: macos-14
                    # Windows x86_64
                    - os: windows-latest
                      arch: x86_64
                      runner: windows-latest
                # å®šæ—¶ä»»åŠ¡åªæµ‹è¯• master ç‰ˆæœ¬ï¼Œå…¶ä»–æƒ…å†µæµ‹è¯•æ‰€æœ‰ç‰ˆæœ¬
                version: ${{ github.event_name == 'schedule' && fromJSON('["master"]') || fromJSON('["0.14.1", "0.15.1", "master"]') }}
            fail-fast: false
        runs-on: ${{ matrix.runner }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Zig
              uses: goto-bus-stop/setup-zig@v2
              with:
                  version: ${{ matrix.version }}

            - name: Run unit tests
              run: zig build test --summary all


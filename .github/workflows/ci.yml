name: CI

on:
    push:
        branches:
            - main
    pull_request:
    schedule:
        - cron: "0 2 * * *"
    workflow_dispatch:

jobs:
    # Job 1: 格式检查
    format-check:
        name: Format Check
        runs-on: ubuntu-latest
        # 在 PR 和 push 到 main 时执行，但不在定时任务时执行
        if: github.event_name != 'schedule'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Zig
              uses: goto-bus-stop/setup-zig@v2
              with:
                  version: 0.15.1

            - name: Check code formatting
              run: zig fmt --check .

    # Job 2: 单元测试
    unit-test:
        name: Unit Test
        needs: format-check
        # 跳过 format-check 的失败，在定时任务时继续执行
        if: always() && (needs.format-check.result == 'success' || github.event_name == 'schedule')
        strategy:
            matrix:
                os: [ubuntu-latest]
                # 定时任务只测试 master 版本，其他情况测试所有版本
                version: ${{ github.event_name == 'schedule' && fromJSON('["master"]') || fromJSON('["0.14.1", "0.15.1", "master"]') }}
            fail-fast: false
        runs-on: ${{ matrix.os }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Zig
              uses: goto-bus-stop/setup-zig@v2
              with:
                  version: ${{ matrix.version }}

            - name: Run unit tests
              run: zig build test --summary all

    # Job 3: 文档生成
    docs:
        name: Generate Documentation
        needs: unit-test
        # 只在 push 到 main 时执行
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Zig
              uses: goto-bus-stop/setup-zig@v2
              with:
                  version: 0.15.1

            - name: Generate docs
              run: zig build docs

            - name: Upload documentation
              uses: actions/upload-artifact@v4
              with:
                  name: documentation
                  path: zig-out/docs/
                  retention-days: 90

    # Job 4: 基准测试
    benchmark:
        name: Benchmark
        needs: unit-test
        # 在 PR 和 push 到 main 时执行，但不在定时任务时执行
        if: github.event_name != 'schedule'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Zig
              uses: goto-bus-stop/setup-zig@v2
              with:
                  version: 0.15.1

            - name: Build benchmark
              run: zig build bench -Doptimize=ReleaseFast

            - name: Run benchmark
              run: zig-out/bin/msgpack-bench > benchmark-results.txt

            - name: Upload benchmark results
              uses: actions/upload-artifact@v4
              with:
                  name: benchmark-results-${{ github.sha }}
                  path: benchmark-results.txt
                  retention-days: 7
